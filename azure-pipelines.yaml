trigger:
  branches:
    include:
      - "*"

pool:
  name: "planet-express-docker-agents"

variables:
- name: usecache
  value: false
- name: netbootIP
  value: 172.28.44.190
- name: netbootUsername
  value: master
- name: folderToPromoteTo
  value: dev

stages:
  - stage: Build
    jobs:
      - job: Build_squashfs
        displayName: Build and propagate squashfs
        workspace:
          clean: all
        steps:
        - task: Docker@2
          inputs:
            containerRegistry: 'DG Modules Container Registry'
            command: 'login'
            addPipelineData: false
          displayName: 'Login to docker registry for build'
        - script: ./build.sh netbootIP=$(netbootIP) branchName=$(Build.SourceBranchName) gitCommitShortSha=$(Build.SourceVersion) useDockerBuildCache=$(usecache) buildSquashfsAndPromote="false"
          workingDirectory: ./build/
          name: buildThinClient
          displayName: 'Build Squashfs'
        - task: Docker@2
          inputs:
            containerRegistry: 'DG Modules Container Registry'
            repository: 'planetexpress/thinclient-base'
            command: 'push'
            Dockerfile: '.'
            buildContext: '.'
            tags: $(buildThinClient.branchName)

